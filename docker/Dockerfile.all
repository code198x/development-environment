# Code198x All-in-One Development Environment
# Contains tools for all supported vintage systems

FROM ubuntu:22.04

LABEL maintainer="Code198x Team"
LABEL description="Complete vintage computing development environment"

ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    wget \
    curl \
    unzip \
    make \
    gcc \
    g++ \
    # Commodore 64 tools
    acme \
    vice \
    # ZX Spectrum tools  
    pasmo \
    fuse-emulator \
    # NES tools
    cc65 \
    # Common tools
    x11-apps \
    xvfb \
    libsdl2-dev \
    libgtk-3-dev \
    libglib2.0-dev \
    libzip-dev \
    # Development tools
    vim \
    nano \
    tmux \
    tree \
    htop \
    && rm -rf /var/lib/apt/lists/*

# Install VASM for Amiga development
RUN mkdir -p /tmp/vasm && \
    cd /tmp/vasm && \
    wget http://sun.hasenbraten.de/vasm/release/vasm.tar.gz && \
    tar xzf vasm.tar.gz && \
    cd vasm && \
    make CPU=m68k SYNTAX=mot && \
    cp vasmm68k_mot vobjdump /usr/local/bin/ && \
    cd / && rm -rf /tmp/vasm

# Install FS-UAE for Amiga emulation
RUN mkdir -p /tmp/fsuae && \
    cd /tmp/fsuae && \
    wget https://fs-uae.net/stable/linux-x86-64/fs-uae_3.1.66_linux-x86-64.tar.xz && \
    tar xf fs-uae_3.1.66_linux-x86-64.tar.xz && \
    cp fs-uae_3.1.66_linux-x86-64/fs-uae /usr/local/bin/ && \
    cp fs-uae_3.1.66_linux-x86-64/fs-uae-device-helper /usr/local/bin/ || true && \
    cd / && rm -rf /tmp/fsuae

# Install Mesen for NES emulation
RUN mkdir -p /tmp/mesen && \
    cd /tmp/mesen && \
    wget -O mesen.tar.gz https://github.com/SourMesen/Mesen2/releases/latest/download/linux-x64.tar.gz && \
    tar xzf mesen.tar.gz && \
    cp Mesen /usr/local/bin/ && \
    cd / && rm -rf /tmp/mesen

# Create development user
RUN useradd -m -s /bin/bash dev && \
    echo "dev:dev" | chpasswd && \
    usermod -aG sudo dev

# Set up workspace
WORKDIR /workspace
RUN chown dev:dev /workspace

# Create directory structure
RUN mkdir -p /workspace/{c64,spectrum,amiga,nes,tools,docs}

# Copy all templates and scripts
COPY templates/ /workspace/templates/
COPY scripts/ /workspace/scripts/
COPY docs/ /workspace/docs/
COPY vscode/ /workspace/.vscode/
RUN chown -R dev:dev /workspace

# Switch to development user
USER dev

# Set up environment
ENV DISPLAY=:99
ENV PATH="/workspace/scripts:$PATH"

# Create welcome script
RUN cat > /workspace/welcome.sh << 'EOF'
#!/bin/bash
echo "🎉 Welcome to Code198x Development Environment!"
echo ""
echo "Available commands:"
echo "  new-project.sh <system> <name>  - Create new project"
echo "  test-system.sh <system>         - Test system tools"
echo ""
echo "Supported systems:"
echo "  📺 c64      - Commodore 64 (ACME + VICE)"
echo "  🌈 spectrum - ZX Spectrum (PASMO + Fuse)"  
echo "  🎨 amiga    - Commodore Amiga (VASM + FS-UAE)"
echo "  🎮 nes      - Nintendo Entertainment System (CC65 + Mesen)"
echo ""
echo "Examples:"
echo "  ./scripts/new-project.sh c64 my-demo"
echo "  cd my-demo && ./build.sh"
echo ""
echo "Documentation: /workspace/docs/"
echo "Templates: /workspace/templates/"
EOF
chmod +x /workspace/welcome.sh

# Create system test script
RUN cat > /workspace/scripts/test-system.sh << 'EOF'
#!/bin/bash
SYSTEM=$1

if [ -z "$SYSTEM" ]; then
    echo "Usage: $0 <system>"
    echo "Systems: c64, spectrum, amiga, nes"
    exit 1
fi

echo "🧪 Testing $SYSTEM development environment..."

case $SYSTEM in
    "c64")
        echo "✓ Testing ACME assembler..."
        acme -h > /dev/null && echo "  ✅ ACME OK" || echo "  ❌ ACME failed"
        echo "✓ Testing VICE emulator..."
        x64sc -help > /dev/null 2>&1 && echo "  ✅ VICE OK" || echo "  ❌ VICE failed"
        ;;
    "spectrum")
        echo "✓ Testing PASMO assembler..."
        pasmo --help > /dev/null 2>&1 && echo "  ✅ PASMO OK" || echo "  ❌ PASMO failed"
        echo "✓ Testing Fuse emulator..."
        fuse --help > /dev/null 2>&1 && echo "  ✅ Fuse OK" || echo "  ❌ Fuse failed"
        ;;
    "amiga")
        echo "✓ Testing VASM assembler..."
        vasmm68k_mot -h > /dev/null 2>&1 && echo "  ✅ VASM OK" || echo "  ❌ VASM failed"
        echo "✓ Testing FS-UAE emulator..."
        fs-uae --help > /dev/null 2>&1 && echo "  ✅ FS-UAE OK" || echo "  ❌ FS-UAE failed"
        ;;
    "nes")
        echo "✓ Testing CC65 assembler..."
        ca65 -h > /dev/null 2>&1 && echo "  ✅ CC65 OK" || echo "  ❌ CC65 failed"
        echo "✓ Testing Mesen emulator..."
        Mesen --help > /dev/null 2>&1 && echo "  ✅ Mesen OK" || echo "  ❌ Mesen failed"
        ;;
    *)
        echo "❌ Unknown system: $SYSTEM"
        exit 1
        ;;
esac

echo "🎉 $SYSTEM test complete!"
EOF
chmod +x /workspace/scripts/test-system.sh

# Default command shows welcome
CMD ["/workspace/welcome.sh", "&&", "/bin/bash"]

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD acme -h > /dev/null && pasmo --help > /dev/null 2>&1 && vasmm68k_mot -h > /dev/null 2>&1 && ca65 -h > /dev/null 2>&1 || exit 1

# Expose ports for web tools
EXPOSE 8080 6000